function msgScroll(){
      $('#frame .content .messages').eq(0).animate({
            scrollTop: $('#conversation-body')[0].scrollHeight
      },300);
}

jQuery(function() {
  if ($('#current-user').size() > 0) {
    App.personal_chat = App.cable.subscriptions.create({
      channel: "NotificationsChannel",
      user_id: $('#current-user').data('id')
    }, {
      connected: function() {},
      disconnected: function() {},
      received: function(data) {
        var conversation;
        conversation = $('#conversation-body');

          if (data['notification']) {
              notify.showNotification('bottom','right',data);
           }
        if (conversation.size() > 0 && conversation.data('conversation-id') === data['conversation_id']) {
          return conversation.append(data['message']);
        } else {
          if ($('#conversations').size() > 0) {
            $.getScript('/conversations');
          }
          //if (data['notification']) {
          //  return $('body').append(data['notification']);
          //}
        }
      },
      send_message: function(message, conversation_id) {
        return this.perform('send_message', {
          message: message,
          conversation_id: conversation_id
        });
      }
    });
      
  }
  // OLD CODE
//   $(document).on('click', '#notification .close', function() {
//     return $(this).parents('#notification').fadeOut(1000);
//   });
//   return $('.async-conversation').submit(function(e) {
//     var $this, textarea;
//     $this = $(this);
//     textarea = $this.find('#personal_message_body');
//     if ($.trim(textarea.val()).length > 0) {
//       App.personal_chat.send_message(textarea.val(), $this.find('#conversation_id').val());
//       textarea.val('');
//     }
//     e.preventDefault();
//     return false;
//   });
// });

// // ---
// // generated by coffee-script 1.9.2

// NEW CODE
  // autoscroll on received

  $(document).on('click', '#notification .close', function() {
    return $(this).parents('#notification').fadeOut(1000);
  });
  return $(document).on('submit', '.async-conversation', function(e) {
    var $this, textarea;
    $this = $(this);
    textarea = $this.find('#personal_message_body');
    if ($.trim(textarea.val()).length > 0) {
      App.personal_chat.send_message(textarea.val(), $this.find('#conversation_id').val());
      textarea.val('');
    }
    e.preventDefault();
    setTimeout(msgScroll,800);

    return false;
  });

});

notify = {
  	showNotification: function(from, align, data){
    	$.notify({
        	message: data['notification']
        },{
            type: 'success',
            timer: 4000,
            placement: {
                from: from,
                align: align
            }
        });
	}

};

// ---
// generated by coffee-script 1.9.2